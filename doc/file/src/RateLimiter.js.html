<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/RateLimiter.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="git+ssh://git@github.com/endlist/simple-limiter.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/RateLimiter.js~RateLimiter.html">RateLimiter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/TokenBucket.js~TokenBucket.html">TokenBucket</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/RateLimiter.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

const TokenBucket = require(&apos;./TokenBucket&apos;);
const _           = require(&apos;lodash&apos;);

/**
 * RateLimiter Class
 *
 * Handles creation and destruction of TokenBuckets by key.
 */
class RateLimiter {

  /**
   * Creates a RateLimiter object.
   *
   * @param {object} config configuration values
   * @property {integer} limit The max amount of tokens per period.
   * @property {integer} period The time in ms before tokens will increment.
   * @property {integer} increment The amount of tokens that will increment each period.
   */
  constructor(config) {
    let limit     = null;
    let period    = null;
    let increment = null;

    if (config != null) {
      limit     = config.limit;
      period    = config.period;
      increment = config.increment;
    }

    this.config = { limit, period, increment };
    this.tokenBuckets = {};
  }

  /**
   * Cleans up each TokenBucket and nulls the array.
   */
  destroy() {
    _.each(this.tokenBuckets, (value, key) =&gt; {
      this.tokenBuckets[key].destroy();
      delete this.tokenBuckets[key];
    });
  }

  /**
   * Helper to throw an error if the key is invalid.
   *
   * @param {key} key The identifier for the request
   * @throws {Error} throw error when key is invalid
   * @private
   */
  _errorCheckForKey(key) {
    if (key == null || typeof(key) != &apos;string&apos;) {
      throw new Error(&apos;Error: key is required.&apos;);
    }
  }

  /**
   * Helper to create a new TokenBucket if needed.
   *
   * @param {string} key The identifier for the request
   * @private
   */
  _createTokenBucket(key) {
    this._errorCheckForKey(key);

    if (this.tokenBuckets[key] == null) {
      const limit = this.config.limit;
      const period = this.config.period;

      this.tokenBuckets[key] = new TokenBucket({ limit, period });
    }
  }

  /**
   * Appropriately decrements the remaining token availability
   * when called and returns the remainder.
   *
   * @param {string} key The identifier for the request
   * @param {integer} [amount] The number to decrement by
   * @return {integer} Remaining request count
   */
  decrementTokens(key, amount) {
    this._errorCheckForKey(key);
    this._createTokenBucket(key);
    this.tokenBuckets[key].decrementTokens(amount);

    return this.tokenBuckets[key].getTokensRemaining();
  }

  /**
   * Returns the remaining request count for the given key.
   * If the key doesn&apos;t already exist, it will create it.
   *
   * @param {string} key The identifier for the request
   * @return {integer} Remaining request count
   */
  getTokensRemaining(key) {
    this._errorCheckForKey(key);
    this._createTokenBucket(key);

    return this.tokenBuckets[key].getTokensRemaining();
  }

}

module.exports = RateLimiter;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.3)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
